<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Convertisseur Crash Gateway JSON ‚Üí Liste horodat√©e</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    html, body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f6fa;
      min-height: 100vh; width: 100vw;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 1.5em .8em 2.5em .8em;
      box-sizing: border-box;
      background: #fff;
      box-shadow: 0 4px 18px rgba(0,0,0,.08);
      border-radius: 18px;
      margin-top: 1.5em;
    }
    h2 {
      text-align: center;
      margin-bottom: 1em;
      color: #222d;
      font-size: 1.3em;
    }
    textarea, .output, input[type="url"] {
      width: 100%;
      box-sizing: border-box;
      font-size: 1.08em;
      padding: 1em;
      margin: 0.7em 0;
      border-radius: 10px;
      border: 1px solid #c5c5c5;
      background: #f7faff;
      resize: vertical;
    }
    textarea { min-height: 90px; max-height: 260px; }
    .output { min-height: 120px; max-height: 280px; background: #f3f9fa;}
    button, label.upload {
      width: 100%;
      padding: 1em;
      font-size: 1.13em;
      border-radius: 10px;
      margin-top: 0.4em;
      margin-bottom: 0.4em;
      font-weight: bold;
      box-shadow: 0 2px 8px #0001;
      cursor: pointer;
      transition: background 0.2s;
    }
    button {
      border: none;
      background: linear-gradient(90deg, #30cfd0 0%, #330867 100%);
      color: #fff;
    }
    button:active {
      background: linear-gradient(90deg, #330867 0%, #30cfd0 100%);
    }
    label.upload {
      background: #f1eaff;
      color: #400080;
      display: block;
      text-align: center;
      border: 1.5px dashed #a17cff;
      margin-bottom: 0.5em;
    }
    input[type="file"] { display: none; }
    .notice {
      font-size: 0.97em;
      color: #444b;
      margin-bottom: 0.4em;
      text-align: center;
    }
    @media (max-width: 600px) {
      .container {
        margin: 0;
        border-radius: 0;
        box-shadow: none;
        padding: 1em 0.3em 1.3em 0.3em;
      }
      h2 { font-size: 1.07em; }
      button, textarea, .output, label.upload, input[type="url"] { font-size: 0.98em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Crash Gateway JSON ‚Üí Liste horodat√©e</h2>
    <div class="notice">
      <strong>1.</strong> Colle l‚ÄôURL de la page Crash ci-dessous, puis clique sur ¬´‚ÄØCharger‚ÄØ¬ª‚ÄØ:<br>
      <input type="url" id="urlInput" placeholder="Colle ici l‚ÄôURL de l‚Äôhistorique crash‚Ä¶" value="https://crash-gateway-cc-cr.gamedev-tech.cc/history?id_n=1play_luckyjet&id_i=1&round_id=3439a721-161a-402d-b15a-f9227d25fef4"/>
      <button onclick="fetchFromUrl()">Charger</button>
      <span style="font-size:.98em;color:#666;">Ou colle/importes ton texte JSON ci-dessous :</span>
      <label for="fileInput" class="upload">üìÅ Importer un fichier texte</label>
      <input type="file" id="fileInput" accept=".txt,.json" />
      <textarea id="jsonInput" placeholder="Colle ici ton JSON ou texte brut"></textarea>
      <strong>2.</strong> Clique sur ¬´‚ÄØConvertir‚ÄØ¬ª pour obtenir la liste format√©e.<br>
      Format‚ÄØ: <code>YYYY-MM-DDTHH:mm:ss | valeur</code>
    </div>
    <button onclick="convertJSON()">Convertir</button>
    <textarea readonly class="output" id="output" placeholder="La liste format√©e appara√Ætra ici..."></textarea>
    <button onclick="copyOutput()">Copier le r√©sultat</button>
    <div id="status" class="notice"></div>
  </div>
  <script>
    function pad(n) { return n < 10 ? "0"+n : n; }
    function formatDate(d) {
      return d.getFullYear() + "-" +
        pad(d.getMonth()+1) + "-" +
        pad(d.getDate()) + "T" +
        pad(d.getHours()) + ":" +
        pad(d.getMinutes()) + ":" +
        pad(d.getSeconds());
    }
    function detectFirstDate(obj) {
      if (obj && typeof obj === "object") {
        for (const key in obj) {
          if (typeof obj[key] === "string" && /^\d{4}-\d{2}-\d{2}[T ]\d{2}:\d{2}:\d{2}$/.test(obj[key])) {
            return new Date(obj[key].replace(" ", "T"));
          }
          if (typeof obj[key] === "number" && obj[key] > 1000000000 && obj[key] < 9999999999) {
            return new Date(obj[key]*1000);
          }
        }
      }
      return null;
    }
    async function fetchFromUrl() {
      const url = document.getElementById('urlInput').value.trim();
      if (!url) {
        document.getElementById('status').innerText = "‚ùå URL manquante.";
        return;
      }
      document.getElementById('status').innerText = "‚è≥ Chargement...";
      try {
        // Pour le cross-origin fetch, il faut que le serveur autorise l'acc√®s (CORS)
        const response = await fetch(url, {mode: "cors"});
        if (!response.ok) throw new Error("Erreur HTTP");
        const text = await response.text();
        // D√©tecte JSON dans la page (si toute la page est JSON c'est direct, sinon essaye d'extraire JSON brute)
        let json = text;
        // Si c'est un objet JSON dans une variable JS, essaye d'extraire
        const match = text.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
        if (match) json = match[0];
        document.getElementById('jsonInput').value = json.trim();
        document.getElementById('status').innerText = "‚úÖ Donn√©es charg√©es. Clique sur Convertir.";
      } catch (e) {
        document.getElementById('status').innerText = "‚ùå Impossible de charger‚ÄØ: "+e;
      }
    }
    function convertJSON() {
      const input = document.getElementById('jsonInput').value.trim();
      let arr, output = "", status = "";
      if (!input) {
        document.getElementById('output').value = "";
        document.getElementById('status').innerText = "";
        return;
      }
      let json = input;
      if (json && json[0] !== "[") json = "[" + json + "]";
      try {
        arr = JSON.parse(json);
      } catch (e) {
        document.getElementById('output').value = "";
        document.getElementById('status').innerText = "‚ùå Erreur de parsing JSON !";
        return;
      }
      if (!Array.isArray(arr) || arr.length === 0) {
        document.getElementById('output').value = "";
        document.getElementById('status').innerText = "‚ùå JSON vide ou au mauvais format.";
        return;
      }
      let date = detectFirstDate(arr[0]);
      if (!date) date = new Date();
      status = "‚úÖ Date de d√©part‚ÄØ: " + formatDate(date);
      for (let i = 0; i < arr.length; i++) {
        const coeff = arr[i].top_coefficient ?? (arr[i].final_values && arr[i].final_values[0]) ?? "";
        output += formatDate(date) + " | " + coeff + "\n";
        date.setMinutes(date.getMinutes() + 1);
      }
      document.getElementById('output').value = output.trim();
      document.getElementById('status').innerText = status;
    }
    function copyOutput() {
      const out = document.getElementById('output');
      out.select();
      out.setSelectionRange(0, 99999);
      document.execCommand('copy');
      document.getElementById('status').innerText = "‚úÖ R√©sultat copi√©‚ÄØ!";
      setTimeout(() => { document.getElementById('status').innerText = ""; }, 1400);
    }
    // Lecture du fichier import√©
    document.getElementById('fileInput').addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          document.getElementById('jsonInput').value = ev.target.result;
        };
        reader.readAsText(e.target.files[0]);
      }
    });
    document.querySelector('label.upload').addEventListener('click', function() {
      document.getElementById('fileInput').click();
    });
  </script>
</body>
</html>
