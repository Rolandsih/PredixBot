<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Convertisseur JSON → CSV (timestamp, multiplicateur)</title>
    <style>
        body {
            background: #f7f7f7;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        h2 {
            margin-top: 2rem;
            color: #333;
        }
        textarea {
            width: 90vw;
            max-width: 700px;
            height: 120px;
            font-size: 1rem;
            margin: 1rem 0;
            padding: 0.8rem;
        }
        button {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 0.8rem 1.6rem;
            font-size: 1.1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        button:hover {
            background: #0056b3;
        }
        table {
            background: #fff;
            border-collapse: collapse;
            margin-bottom: 2rem;
            min-width: 320px;
            box-shadow: 0 2px 10px #ddd;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 0.6em 1em;
            text-align: center;
        }
        th {
            background: #f0f0f0;
        }
        .export {
            margin-bottom: 1.5rem;
        }
        .csv-output {
            width: 90vw;
            max-width: 700px;
            height: 80px;
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body>
    <h2>Convertisseur JSON → CSV (timestamp, multiplicateur)</h2>
    <p>Colle ici tes données JSON :</p>
    <textarea id="jsonInput" placeholder='Colle ici ton tableau JSON...'></textarea><br>
    <button onclick="convertJSON()">Convertir</button>
    <div id="tableDiv"></div>
    <div class="export">
      <button onclick="exportCSV()">Exporter en CSV</button>
    </div>
    <textarea id="csvOutput" class="csv-output" readonly placeholder="Le CSV apparaîtra ici..."></textarea>

    <script>
        // Simule une date aléatoire (pour la démo) si aucune n'est présente
        function randomDate() {
            const now = new Date();
            const delta = Math.floor(Math.random() * 1000000);
            return new Date(now.getTime() - delta * 1000);
        }
        // Conversion de timestamp UNIX en format lisible
        function formatDate(d) {
            const pad = (v) => v < 10 ? "0" + v : v;
            return d.getFullYear() + "-" + pad(d.getMonth()+1) + "-" + pad(d.getDate()) +
                " " + pad(d.getHours()) + ":" + pad(d.getMinutes()) + ":" + pad(d.getSeconds());
        }

        let lastTimestamps = {};

        function convertJSON() {
            let input = document.getElementById('jsonInput').value.trim();
            let arr;
            // Corrige si l'utilisateur oublie les crochets autour du JSON
            if (input && input[0] !== "[") input = "[" + input + "]";
            try {
                arr = JSON.parse(input);
            } catch(e) {
                document.getElementById('tableDiv').innerHTML = "<span style='color:red'>Erreur de parsing JSON !</span>";
                document.getElementById('csvOutput').value = "";
                return;
            }
            // Affiche la table
            let html = "<table><thead><tr><th>Timestamp</th><th>Multiplicateur</th></tr></thead><tbody>";
            let csv = "timestamp,multiplicateur\n";
            arr.forEach((obj, i) => {
                // Génère un timestamp si absent (ou à adapter selon tes vraies données !)
                let timestamp = obj.timestamp;
                if (!timestamp) {
                    // Pour la démo, on simule un timestamp
                    let fake = new Date(Date.now() - (arr.length - i) * 60000);
                    timestamp = formatDate(fake);
                }
                // Prends le top_coefficient comme multiplicateur
                let mult = obj.top_coefficient || (obj.final_values && obj.final_values[0]) || "";
                html += `<tr><td>${timestamp}</td><td>${mult}</td></tr>`;
                csv += `${timestamp},${mult}\n`;
            });
            html += "</tbody></table>";
            document.getElementById('tableDiv').innerHTML = html;
            document.getElementById('csvOutput').value = csv.trim();
        }

        function exportCSV() {
            let csv = document.getElementById('csvOutput').value;
            if (!csv) return;
            const blob = new Blob([csv], {type: 'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "export.csv";
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }
    </script>
</body>
</html>
